/**
 * EXTRACTOR DE CONTROLES DEL TAB CONFIGURACI√ìN
 * Copia y pega este c√≥digo completo en la consola de Chrome
 */

(function() {
    console.log('üöÄ Iniciando extracci√≥n del tab Configuraci√≥n...');
    
    // ========== PASO 1: ENCONTRAR EL TAB CONFIGURACI√ìN ==========
    function findConfigTab() {
        // Buscar el tab panel activo visible
        const panels = document.querySelectorAll('[role="tabpanel"], .tab-pane, .tab-content > div');
        
        for (let panel of panels) {
            const isVisible = panel.offsetParent !== null && 
                            !panel.classList.contains('hidden') && 
                            panel.style.display !== 'none';
            
            if (isVisible) {
                console.log('‚úÖ Tab encontrado:', panel);
                return panel;
            }
        }
        
        // Si no encuentra, intentar buscar por el contenedor principal visible
        const mainContent = document.querySelector('.tab-content, [class*="tab"]');
        if (mainContent) {
            return mainContent;
        }
        
        return null;
    }
    
    // ========== PASO 2: EXTRAER INFORMACI√ìN DE CONTROLES ==========
    function extractControlInfo(element, index) {
        const rect = element.getBoundingClientRect();
        const computed = window.getComputedStyle(element);
        
        // Identificar tipo de control
        let controlType = element.tagName.toLowerCase();
        if (element.tagName === 'INPUT') {
            controlType = `input-${element.type}`;
        }
        
        // Informaci√≥n b√°sica del control
        const info = {
            index: index,
            tipo: controlType,
            id: element.id || null,
            nombre: element.name || null,
            clase: element.className || null,
            
            // Texto y valores
            etiqueta: element.textContent?.trim().substring(0, 50) || null,
            valor: element.value || null,
            placeholder: element.placeholder || null,
            
            // Posici√≥n y dimensiones
            posicion: {
                x: Math.round(rect.left + window.scrollX),
                y: Math.round(rect.top + window.scrollY),
                ancho: Math.round(rect.width),
                alto: Math.round(rect.height)
            },
            
            // Atributos especiales
            requerido: element.required || false,
            deshabilitado: element.disabled || false,
            visible: element.offsetParent !== null
        };
        
        // Para checkboxes y switches
        if (element.type === 'checkbox' || element.classList.contains('switch')) {
            info.checked = element.checked;
        }
        
        // Para selects
        if (element.tagName === 'SELECT') {
            info.opciones = Array.from(element.options).map(opt => ({
                valor: opt.value,
                texto: opt.text,
                seleccionado: opt.selected
            }));
        }
        
        return info;
    }
    
    function extractControlStyles(element, index) {
        const computed = window.getComputedStyle(element);
        
        return {
            index: index,
            tipo: element.tagName.toLowerCase(),
            id: element.id || null,
            clase: element.className || null,
            
            estilos: {
                // Tipograf√≠a
                fontFamily: computed.fontFamily,
                fontSize: computed.fontSize,
                fontWeight: computed.fontWeight,
                color: computed.color,
                textAlign: computed.textAlign,
                
                // Fondo y bordes
                backgroundColor: computed.backgroundColor,
                border: computed.border,
                borderRadius: computed.borderRadius,
                
                // Espaciado
                padding: computed.padding,
                margin: computed.margin,
                
                // Dimensiones
                width: computed.width,
                height: computed.height,
                minWidth: computed.minWidth,
                minHeight: computed.minHeight,
                
                // Efectos
                boxShadow: computed.boxShadow,
                opacity: computed.opacity,
                
                // Display
                display: computed.display,
                position: computed.position
            }
        };
    }
    
    // ========== PASO 3: PROCESAR TODOS LOS CONTROLES ==========
    function extractAllControls(container) {
        console.log('üì¶ Extrayendo controles del contenedor...');
        
        // Selectores de controles de formulario
        const selectors = [
            'input',
            'select',
            'textarea',
            'button',
            '[class*="switch"]',
            '[class*="toggle"]',
            '[class*="chip"]',
            '[class*="tag"]',
            'label'
        ];
        
        const controls = container.querySelectorAll(selectors.join(', '));
        console.log(`‚úÖ ${controls.length} controles encontrados`);
        
        const componentsData = [];
        const stylesData = [];
        
        controls.forEach((control, index) => {
            componentsData.push(extractControlInfo(control, index));
            stylesData.push(extractControlStyles(control, index));
        });
        
        return { componentsData, stylesData };
    }
    
    // ========== PASO 4: DESCARGAR ARCHIVOS ==========
    function downloadJSON(data, filename) {
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log(`üíæ Descargado: ${filename}`);
    }
    
    // ========== EJECUTAR EXTRACCI√ìN ==========
    const configTab = findConfigTab();
    
    if (!configTab) {
        console.error('‚ùå No se encontr√≥ el tab de Configuraci√≥n');
        console.log('üí° Ejecuta manualmente:');
        console.log('   const container = document.querySelector("TU_SELECTOR");');
        console.log('   extractManual(container);');
        return;
    }
    
    const { componentsData, stylesData } = extractAllControls(configTab);
    
    // Crear estructura final con metadata
    const componentesArchivo = {
        fecha: new Date().toISOString(),
        url: window.location.href,
        totalControles: componentsData.length,
        controles: componentsData
    };
    
    const estilosArchivo = {
        fecha: new Date().toISOString(),
        url: window.location.href,
        totalControles: stylesData.length,
        estilos: stylesData
    };
    
    // Descargar archivos
    downloadJSON(componentesArchivo, 'configuracion-componentes.json');
    downloadJSON(estilosArchivo, 'configuracion-estilos.json');
    
    console.log('‚úÖ EXTRACCI√ìN COMPLETADA');
    console.log('üìä Total de controles extra√≠dos:', componentsData.length);
    console.log('üìÅ Archivos descargados:');
    console.log('   1. configuracion-componentes.json');
    console.log('   2. configuracion-estilos.json');
    
    // Funci√≥n auxiliar para extracci√≥n manual
    window.extractManual = function(container) {
        if (!container) {
            console.error('‚ùå Proporciona un elemento v√°lido');
            return;
        }
        const { componentsData, stylesData } = extractAllControls(container);
        downloadJSON({ controles: componentsData }, 'configuracion-componentes.json');
        downloadJSON({ estilos: stylesData }, 'configuracion-estilos.json');
        console.log('‚úÖ Extracci√≥n manual completada');
    };
    
    return {
        componentes: componentesArchivo,
        estilos: estilosArchivo
    };
})();