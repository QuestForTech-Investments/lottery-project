# Cambios realizados - 5 de Febrero 2026

## 1. Cambio de prefijo de código de banca: LAN- → LB-

### Archivo modificado
`api/src/LotteryApi/Controllers/BettingPoolsController.cs`

### Cambios
- Cambiado el prefijo de código de banca de `LAN-XXXX` a `LB-XXXX`
- La secuencia ahora se basa en el máximo código LB- existente, no en el ID de la banca
- Ejemplo: Si el máximo es LB-0013, el próximo será LB-0014

### Código actualizado
```csharp
// GetNextCode() - Genera el próximo código disponible
var lbCodes = await _context.BettingPools
    .Where(bp => bp.BettingPoolCode.StartsWith("LB-"))
    .Select(bp => bp.BettingPoolCode)
    .ToListAsync();

int maxNumber = 0;
foreach (var code in lbCodes)
{
    if (code.Length > 3 && int.TryParse(code.Substring(3), out int num))
    {
        if (num > maxNumber) maxNumber = num;
    }
}

string nextCode = $"LB-{(maxNumber + 1):D4}";
```

### Base de datos
- Se actualizó la banca ID 39 de `LAN-0039` a `LB-0013`

---

## 2. Creación automática de usuario POS al crear banca

### Problema
Cuando se creaba una banca con username/password, estos se guardaban en `BettingPool.Username` y `BettingPool.PasswordHash`, pero NO se creaba un usuario en la tabla `Users` ni se asociaba en `UserBettingPools`. Por esto, en el listado de bancas aparecía "Sin usuarios".

### Solución
Al crear una banca con username y password:
1. Se valida que username y password sean requeridos
2. Se verifica que el username no exista
3. Se crea automáticamente un usuario con rol POS
4. Se asocia el usuario con la banca en `UserBettingPools`
5. El usuario ahora aparece en el listado de bancas

### Archivo modificado
`api/src/LotteryApi/Controllers/BettingPoolsController.cs`

### Validaciones agregadas
```csharp
// Username y password son requeridos
if (string.IsNullOrWhiteSpace(dto.Username))
    return BadRequest(new { message = "El nombre de usuario es requerido" });

if (string.IsNullOrWhiteSpace(dto.Password))
    return BadRequest(new { message = "La contraseña es requerida" });

// Verificar que el username no exista
var userExists = await _context.Users
    .AnyAsync(u => u.Username.ToLower() == dto.Username.ToLower());
if (userExists)
    return Conflict(new { message = "Ya existe un usuario con ese nombre" });
```

### Creación automática de usuario POS
```csharp
// Crear usuario POS
var user = new User
{
    Username = dto.Username,
    PasswordHash = BCrypt.Net.BCrypt.HashPassword(dto.Password),
    FullName = dto.BettingPoolName,
    Email = $"{dto.Username}@pos.local",
    RoleId = posRole.RoleId,
    IsActive = true,
    CreatedAt = DateTime.UtcNow
};

_context.Users.Add(user);
await _context.SaveChangesAsync();

// Asociar usuario con banca
var userBettingPool = new UserBettingPool
{
    UserId = user.UserId,
    BettingPoolId = bettingPool.BettingPoolId,
    IsActive = true,
    CreatedAt = DateTime.UtcNow
};

_context.UserBettingPools.Add(userBettingPool);
await _context.SaveChangesAsync();
```

---

## 3. Deshabilitación de autocompletado del navegador

### Problema
El navegador autocompletaba los campos de usuario y contraseña con credenciales guardadas (ej: "admin") en los formularios de creación de banca y usuarios.

### Solución
Se agregó `autoComplete="off"` a campos de username y `autoComplete="new-password"` a campos de password en todos los formularios excepto el login.

### Archivos modificados
- `frontend-v4/src/components/features/betting-pools/CreateBettingPool/tabs/GeneralTab.tsx`
- `frontend-v4/src/components/features/betting-pools/CreateBettingPool/tabs/UsersTab.tsx`
- `frontend-v4/src/components/features/betting-pools/UserBettingPools/index.tsx`
- `frontend-v4/src/components/features/users/CreateUser/index.tsx`
- `frontend-v4/src/components/features/users/UserAdministrators/index.tsx`
- `frontend-v4/src/components/features/users/UsersTabbed/UserAdministratorsContent.tsx`
- `frontend-v4/src/components/features/users/UsersTabbed/UserBettingPoolsContent.tsx`

### Ejemplo de cambio
```tsx
<TextField
  label="Nombre de usuario"
  name="username"
  autoComplete="off"  // Agregado
/>

<TextField
  type="password"
  label="Contraseña"
  autoComplete="new-password"  // Agregado
/>
```

### Campos ocultos para atrapar autocompletado
En `GeneralTab.tsx` se agregaron campos ocultos que "atrapan" el autocompletado del navegador:
```tsx
<input type="text" name="fake_username" style={{ display: 'none' }} autoComplete="username" />
<input type="password" name="fake_password" style={{ display: 'none' }} autoComplete="current-password" />
```

---

## 4. Organización de archivos PNG

### Cambio
Se movieron todos los archivos `.png` dispersos en el proyecto a una carpeta centralizada `captures/`.

### Carpetas origen
- Raíz del proyecto
- `.playwright-mcp/`
- `.playwright-mcp/.playwright-mcp/`
- `scripts/`

### Resultado
- 189 archivos PNG movidos a `captures/`

---

## 5. Verificación: Eliminación de bancas

### Investigación
Se revisó la aplicación original (https://la-numbers.apk.lol) para verificar cómo manejan la eliminación de bancas.

### Hallazgo
**En la aplicación original las bancas NO se eliminan, solo se desactivan (soft delete).**

- La lista de bancas tiene un switch de "Activa" para activar/desactivar
- No hay botón de eliminar en ningún lugar
- El menú de Bancas solo tiene: Lista, Crear, Edición masiva

### Conclusión
Nuestro sistema ya implementa este comportamiento correctamente (soft delete mediante desactivación).

---

## Commits realizados

1. `ce8e103` - Change betting pool code prefix from LAN- to LB- and fix sequence
2. `4ef92b8` - Disable browser autocomplete on betting pool form fields
3. `605aa43` - Add hidden fields to trap browser autocomplete
4. `1471dfd` - Auto-create POS user when creating betting pool
5. `b0012de` - Disable browser autocomplete on all password forms except login

---

## Estado de las bancas Lottobook

| ID | Código | Nombre |
|----|--------|--------|
| 9 | LB-0001 | Lottobook 01 |
| 28 | LB-0002 | Lottobook 02 |
| 29 | LB-0003 | Lottobook 03 |
| 30 | LB-0004 | Lottobook 04 |
| 31 | LB-0005 | Lottobook 05 |
| 32 | LB-0006 | Lottobook 06 |
| 33 | LB-0007 | Lottobook 07 |
| 34 | LB-0008 | Lottobook 08 |
| 35 | LB-0009 | Lottobook 09 |
| 36 | LB-0010 | Lottobook 10 |
| 37 | LB-0011 | Lottobook 11 |
| 38 | LB-0012 | Lottobook 12 |
| 39 | LB-0013 | Lottobook 13 |

**Próximo código disponible:** LB-0014
