<!DOCTYPE html>
<html>
<head>
    <title>DEBUG - Prize Loading Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Test de Carga de Premios - Banca 9</h1>
    <button onclick="runTest()">üöÄ Ejecutar Test</button>
    <div id="output"></div>

    <script>
        const API_BASE = 'http://localhost:5000';

        async function log(msg, type = 'info') {
            const output = document.getElementById('output');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<div class="${className}">${msg}</div>`;
            console.log(msg);
        }

        async function runTest() {
            document.getElementById('output').innerHTML = '';

            try {
                // 1. Test GET /api/prize-fields (defaults)
                await log('\n=== üìã PASO 1: Obtener Prize Fields (Defaults) ===');
                const defaultResponse = await fetch(`${API_BASE}/api/prize-fields`);
                const defaultData = await defaultResponse.json();
                await log(`‚úÖ Recibidos ${defaultData.length} tipos de apuesta con defaults`, 'success');

                let totalDefaultFields = 0;
                defaultData.forEach(betType => {
                    const fields = betType.prizeFields || betType.PrizeFields || [];
                    totalDefaultFields += fields.length;
                });
                await log(`   üìä Total de campos con valores default: ${totalDefaultFields}`, 'info');

                // Mostrar primeros 5 campos de ejemplo
                const firstBetType = defaultData[0];
                const firstFields = firstBetType.prizeFields || firstBetType.PrizeFields || [];
                await log(`   üîç Ejemplo - Primer betType: ${firstBetType.betTypeCode || firstBetType.BetTypeCode}`, 'info');
                await log(`   üîç Primeros 3 campos:`, 'info');
                firstFields.slice(0, 3).forEach(f => {
                    await log(`      - ${f.fieldCode || f.FieldCode}: ${f.defaultValue || f.DefaultValue}`, 'info');
                });

                // 2. Test GET /api/betting-pools/9/prize-config (custom)
                await log('\n=== üéØ PASO 2: Obtener Configuraci√≥n Custom de Banca 9 ===');
                const customResponse = await fetch(`${API_BASE}/api/betting-pools/9/prize-config`);
                const customData = await customResponse.json();

                if (!customData || customData.length === 0) {
                    await log(`‚ö†Ô∏è NO HAY CONFIGURACI√ìN CUSTOM para Banca 9`, 'error');
                    await log(`   Esto significa que la banca usa solo valores default`, 'info');
                } else {
                    await log(`‚úÖ Recibidos ${customData.length} configuraciones custom`, 'success');
                    await log(`\n   üì¶ Primeros 5 valores custom:`, 'info');
                    customData.slice(0, 5).forEach(config => {
                        await log(`      - ${config.fieldCode || config.FieldCode}: ${config.value || config.Value}`, 'info');
                    });

                    await log(`\n   üì¶ JSON completo de custom configs:`, 'info');
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(customData, null, 2);
                    document.getElementById('output').appendChild(pre);
                }

                // 3. Test estructura del response
                await log('\n=== üî¨ PASO 3: Validar Estructura del Response ===');
                if (customData && customData.length > 0) {
                    const firstCustom = customData[0];
                    await log(`   Estructura de la primera config:`, 'info');
                    await log(`   - Tiene fieldCode: ${!!firstCustom.fieldCode || !!firstCustom.FieldCode} (${firstCustom.fieldCode || firstCustom.FieldCode})`, 'info');
                    await log(`   - Tiene value: ${!!firstCustom.value || !!firstCustom.Value} (${firstCustom.value || firstCustom.Value})`, 'info');
                    await log(`   - Tiene prizeFieldId: ${!!firstCustom.prizeFieldId || !!firstCustom.PrizeFieldId} (${firstCustom.prizeFieldId || firstCustom.PrizeFieldId})`, 'info');

                    // Buscar DIRECTO_PRIMER_PAGO espec√≠ficamente
                    const directoPrimerPago = customData.find(c =>
                        (c.fieldCode || c.FieldCode) === 'DIRECTO_PRIMER_PAGO'
                    );
                    if (directoPrimerPago) {
                        await log(`\n   üéØ DIRECTO_PRIMER_PAGO encontrado:`, 'success');
                        await log(`      Value: ${directoPrimerPago.value || directoPrimerPago.Value}`, 'info');
                    } else {
                        await log(`\n   ‚ùå DIRECTO_PRIMER_PAGO NO encontrado en custom configs`, 'error');
                    }
                }

                // 4. Simular merge
                await log('\n=== üîÑ PASO 4: Simular Merge (Default + Custom) ===');
                const merged = {};

                // Add defaults
                defaultData.forEach(betType => {
                    const fields = betType.prizeFields || betType.PrizeFields || [];
                    fields.forEach(field => {
                        const fieldCode = field.fieldCode || field.FieldCode;
                        merged[fieldCode] = field.defaultValue || field.DefaultValue || 0;
                    });
                });
                await log(`   ‚úÖ Agregados ${Object.keys(merged).length} valores default`, 'info');

                // Override with custom
                if (customData && customData.length > 0) {
                    customData.forEach(config => {
                        const fieldCode = config.fieldCode || config.FieldCode;
                        merged[fieldCode] = config.value || config.Value;
                    });
                    await log(`   ‚úÖ Override con ${customData.length} valores custom`, 'success');
                } else {
                    await log(`   ‚ö†Ô∏è No hay valores custom para override`, 'error');
                }

                // Check DIRECTO_PRIMER_PAGO
                if (merged['DIRECTO_PRIMER_PAGO']) {
                    await log(`\n   üéØ DIRECTO_PRIMER_PAGO despu√©s del merge: ${merged['DIRECTO_PRIMER_PAGO']}`, 'success');
                } else {
                    await log(`\n   ‚ùå DIRECTO_PRIMER_PAGO NO existe despu√©s del merge`, 'error');
                }

            } catch (error) {
                await log(`\n‚ùå ERROR: ${error.message}`, 'error');
                await log(`Stack: ${error.stack}`, 'error');
            }
        }
    </script>
</body>
</html>
